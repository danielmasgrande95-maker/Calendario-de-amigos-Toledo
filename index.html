<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario Toledo ‚Äî Amigos</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.12)' },
          borderRadius: { xl2: '1.25rem' },
          fontFamily: { display: ['Inter', 'ui-sans-serif', 'system-ui'] },
        }
      }
    }
  </script>
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek)</script>
  <!-- Supabase client (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { height: 100%; }
    .glass { backdrop-filter: blur(8px); }
    .btn-glass { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.35); }
    .cell { transition: transform .15s ease, box-shadow .15s ease; }
    .cell:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,.08); }
    .chip { white-space: nowrap; }
  </style>
</head>
<body class="min-h-screen font-display text-slate-900" style="background: linear-gradient(135deg, #e0f2fe 0%, #fdf2f2 35%, #fff7ed 100%);">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- HEADER -->
    <header class="rounded-2xl shadow-soft border border-white/50 glass p-4 md:p-6 bg-white/40 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Calendario Toledo</h1>
        <p class="text-slate-700/80">Marca cu√°ndo est√°s en Toledo. Fines de semana resaltados. El d√≠a m√°s concurrido del mes lleva una <span title="Top d√≠a">üèÜ</span>.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <label class="text-sm text-slate-700/80">Amigo</label>
        <select id="friendSelect" class="px-3 py-2 rounded-xl border border-white/50 shadow-soft bg-white/60 glass">
          <option>David</option>
          <option>Alberto</option>
          <option>Virgilio</option>
          <option>Enrique</option>
          <option>Fernando</option>
          <option>Alfonso</option>
          <option>Nacho</option>
          <option selected>Dani</option>
        </select>
        <div class="hidden md:flex w-px h-6 bg-white/60 mx-1"></div>
        <button id="prevBtn" class="btn-glass px-3 py-2 rounded-xl border shadow-soft">‚óÄ Mes</button>
        <div id="monthLabel" class="min-w-[180px] text-center font-medium"></div>
        <button id="nextBtn" class="btn-glass px-3 py-2 rounded-xl border shadow-soft">Mes ‚ñ∂</button>
      </div>
    </header>

    <section class="grid md:grid-cols-[2fr,1fr] gap-6 mt-6">
      <!-- CALENDAR -->
      <div class="rounded-2xl border border-white/50 bg-white/60 glass shadow-soft p-4">
        <div class="grid grid-cols-7 text-center text-slate-700/80 text-xs uppercase tracking-wide mb-2">
          <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div class="font-semibold">S√°b</div><div class="font-semibold">Dom</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
        <div class="mt-3 text-xs text-slate-700/70 flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full" style="background:#3b82f6;"></span> pocos ‚Üí
          <span class="inline-block w-3 h-3 rounded-full" style="background:#f59e0b;"></span> muchos ¬∑ chips = nombres ¬∑ üèÜ = top del mes
        </div>
      </div>

      <!-- SIDEBAR -->
      <aside class="space-y-4">
        <div class="rounded-2xl border border-white/50 bg-white/60 glass shadow-soft p-4">
          <h2 class="font-medium mb-2">Fines de semana üîé</h2>
          <ul id="topWeekends" class="text-sm space-y-2"></ul>
        </div>
        <div class="rounded-2xl border border-white/50 bg-white/50 glass p-4">
          <h3 class="font-medium mb-1">Estado</h3>
          <p id="backendStatus" class="text-xs text-slate-700/80">Guardando en local (sin backend).</p>
        </div>
      </aside>
    </section>

    <footer class="mt-8 text-xs text-slate-700/70">UI con degradados azul‚Üínaranja, botones semitransparentes y chips que no se pisan. Simple y bonito, como debe.</footer>
  </div>

  <script>
    // ======= 1) CONFIG =======
    // OPCIONAL: pega tus claves de Supabase aqu√≠ para que se guarde para todos.
    const SUPABASE_URL = "https://dcwiwqjzuvfnprbezkst.supabase.co"; // p.ej. https://xyzcompany.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjd2l3cWp6dXZmbnByYmV6a3N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3Njk5ODEsImV4cCI6MjA3NTM0NTk4MX0.r9_VgjWdWrS2w6CtnwydcOsfTucy0aC9TTN5RGC69sk"; // p.ej. eyJhbGciOiJIUzI1...

    // Si se rellenan, se usar√° Supabase; si no, fallback a localStorage
    let supabase = null;
    if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
      try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch (e) { console.warn(e); }
    }

    const FRIENDS = ["David","Alberto","Virgilio","Enrique","Fernando","Alfonso","Nacho","Dani"];
    let viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth(); // 0..11

    // ======= 2) ESTADO =======
    // Map('YYYY-MM-DD' -> Set([nombres]))
    const state = new Map();
    const LOCAL_KEY = 'toledo-calendar';

    // ======= 3) UI HOOKS =======
    const grid = document.getElementById('calendarGrid');
    const label = document.getElementById('monthLabel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const friendSelect = document.getElementById('friendSelect');
    const topWeekends = document.getElementById('topWeekends');
    const backendStatus = document.getElementById('backendStatus');

    prevBtn.onclick = () => { viewMonth--; if (viewMonth < 0) { viewMonth = 11; viewYear--; } draw(); };
    nextBtn.onclick = () => { viewMonth++; if (viewMonth > 11) { viewMonth = 0; viewYear++; } draw(); };

    // ======= 4) HELPERS =======
    const fmt = (d) => dayjs(d).format('YYYY-MM-DD');
    const isWeekend = (d) => { const wd = dayjs(d).day(); return wd === 0 || wd === 6; };

    function saveLocal() {
      const obj = {}; state.forEach((set, day) => obj[day] = Array.from(set));
      localStorage.setItem(LOCAL_KEY, JSON.stringify(obj));
    }
    function loadLocal() {
      const raw = localStorage.getItem(LOCAL_KEY); if (!raw) return;
      try { const obj = JSON.parse(raw); Object.entries(obj).forEach(([k, arr]) => state.set(k, new Set(arr))); } catch {}
    }

    function friendColor(name) {
      let h=0; for (let i=0; i<name.length; i++) h = (h*31 + name.charCodeAt(i)) >>> 0; h%=360;
      return `hsl(${h} 70% 40%)`;
    }

    function gradByCount(count, weekend) {
      const maxN = 6; const t = Math.min(count / maxN, 1);
      const c1 = {r:59,g:130,b:246};   // blue-500
      const c2 = {r:245,g:158,b:11};   // amber-500
      const r = Math.round(c1.r + (c2.r-c1.r)*t);
      const g = Math.round(c1.g + (c2.g-c1.g)*t);
      const b = Math.round(c1.b + (c2.b-c1.b)*t);
      const base = `rgba(${r},${g},${b},${weekend?0.18:0.12})`;
      const edge = `rgba(${r},${g},${b},${weekend?0.35:0.25})`;
      return `linear-gradient(180deg, ${base} 0%, rgba(255,255,255,0.65) 60%), ${edge}`;
    }

    function topDayOfMonth(year, month) {
      let best = null; let bestCount = -1;
      const daysInMonth = dayjs(new Date(year, month, 1)).daysInMonth();
      for (let d=1; d<=daysInMonth; d++) {
        const key = fmt(new Date(year, month, d));
        const c = state.get(key)?.size || 0;
        if (c > bestCount) { bestCount = c; best = key; }
      }
      return {key: best, count: bestCount};
    }

    function weekendSummary(year, month) {
      const first = dayjs(new Date(year, month, 1)).startOf('month');
      const last  = dayjs(new Date(year, month, 1)).endOf('month');
      const buckets = [];
      let d = first;
      while (d.isBefore(last) || d.isSame(last, 'day')) {
        if (d.day() === 6) { // s√°bado
          const sat = d.format('YYYY-MM-DD');
          const sun = d.add(1, 'day').format('YYYY-MM-DD');
          const count = (state.get(sat)?.size || 0) + (state.get(sun)?.size || 0);
          buckets.push({ label: `${d.format('DD MMM')} ¬∑ finde`, count, sat, sun });
        }
        d = d.add(1, 'day');
      }
      buckets.sort((a,b)=>b.count - a.count);
      return buckets.slice(0, 4);
    }

    function paintSummary() {
      topWeekends.innerHTML = '';
      weekendSummary(viewYear, viewMonth).forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<div class="flex items-center justify-between p-2 rounded-xl border bg-white/70 glass ${item.count>0?'border-amber-300':'border-white/60'}">
          <div>
            <div class="font-medium">${item.label}</div>
            <div class="text-xs text-slate-700/80">Asistentes: <span class="font-semibold">${item.count}</span></div>
          </div>
          <div class="text-right text-xs">
            <div>${item.sat}</div>
            <div>${item.sun}</div>
          </div>
        </div>`;
        topWeekends.appendChild(li);
      });
    }

    function paintCells() {
      const cells = grid.querySelectorAll('[data-date]');
      const top = topDayOfMonth(viewYear, viewMonth);

      cells.forEach(c => {
        const dayKey = c.dataset.date;
        const set = state.get(dayKey) || new Set();
        const count = set.size;
        const weekend = isWeekend(dayKey);
        const isTop = top.key === dayKey && top.count > 0;

        c.style.background = gradByCount(count, weekend);
        c.style.borderColor = `rgba(0,0,0,${count?0.08:0.06})`;

        const dayNum = c.querySelector('.day-num');
        dayNum.textContent = dayjs(dayKey).date();
        const badge = c.querySelector('.badge');
        badge.textContent = count>0 ? count : '';
        const medal = c.querySelector('.medal');
        medal.textContent = isTop ? 'üèÜ' : '';

        const rack = c.querySelector('.rack');
        rack.innerHTML = '';
        if (count > 0) {
          const maxChips = 6;
          const arr = Array.from(set);
          arr.slice(0, maxChips).forEach(name => {
            const chip = document.createElement('span');
            chip.className = 'chip text-[11px] px-2 py-0.5 rounded-full border mr-1 mb-1';
            chip.style.background = 'rgba(255,255,255,0.65)';
            chip.style.borderColor = 'rgba(0,0,0,0.08)';
            chip.style.color = friendColor(name);
            chip.textContent = name;
            rack.appendChild(chip);
          });
          if (arr.length > maxChips) {
            const more = document.createElement('span');
            more.className = 'chip text-[11px] px-2 py-0.5 rounded-full border mr-1 mb-1 text-slate-700/80';
            more.style.background = 'rgba(255,255,255,0.65)';
            more.style.borderColor = 'rgba(0,0,0,0.08)';
            more.textContent = `+${arr.length-maxChips}`;
            rack.appendChild(more);
          }
        }

        const me = friendSelect.value;
        if (set.has(me)) {
          c.classList.add('ring-1');
          c.style.boxShadow = 'inset 0 0 0 2px rgba(16,185,129,0.35)';
        } else {
          c.classList.remove('ring-1');
          c.style.boxShadow = '';
        }
      });

      paintSummary();
    }

    function draw() {
      label.textContent = dayjs(new Date(viewYear, viewMonth, 1)).format('MMMM YYYY');
      grid.innerHTML = '';

      const first = dayjs(new Date(viewYear, viewMonth, 1));
      const startWeekday = (first.day() + 6) % 7; // lunes=0
      const daysInMonth = first.daysInMonth();

      for (let i=0; i<startWeekday; i++) grid.appendChild(document.createElement('div'));

      for (let d=1; d<=daysInMonth; d++) {
        const date = new Date(viewYear, viewMonth, d);
        const key = fmt(date);
        const weekend = isWeekend(key);

        const cell = document.createElement('button');
        cell.className = `cell relative p-2 rounded-xl border bg-white/60 glass text-left`;
        cell.setAttribute('data-date', key);
        cell.onclick = () => toggleDay(key, friendSelect.value);

        cell.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="day-num text-sm font-semibold ${weekend?'text-slate-900':'text-slate-800'}"></div>
            <div class="flex items-center gap-1">
              <span class="medal text-base"></span>
              <span class="badge inline-flex items-center justify-center min-w-[1.5rem] h-6 px-1 rounded-full text-xs bg-white/70 glass border border-white/70"></span>
            </div>
          </div>
          <div class="rack mt-2 flex flex-wrap overflow-hidden"></div>
        `;
        grid.appendChild(cell);
      }

      paintCells();
    }

    async function loadRemote(year) {
      if (!supabase) return;
      const start = dayjs(`${year}-01-01`).format('YYYY-MM-DD');
      const end = dayjs(`${year}-12-31`).format('YYYY-MM-DD');
      const { data, error } = await supabase
        .from('availability')
        .select('date, user')
        .gte('date', start)
        .lte('date', end);
      if (error) { console.warn('Supabase load error', error); return; }
      data.forEach(row => {
        const key = row.date; if (!state.has(key)) state.set(key, new Set());
        state.get(key).add(row.user);
      });
    }

    async function toggleDay(dateStr, user) {
      if (!state.has(dateStr)) state.set(dateStr, new Set());
      const set = state.get(dateStr);
      const had = set.has(user);
      if (had) set.delete(user); else set.add(user);
      saveLocal();
      paintCells();

      if (supabase) {
        backendStatus.textContent = 'Guardando en Supabase‚Ä¶';
        if (!had) {
          const { error } = await supabase.from('availability').upsert({ date: dateStr, user });
          if (error) console.warn('Supabase upsert error', error);
        } else {
          const { error } = await supabase.from('availability').delete().eq('date', dateStr).eq('user', user);
          if (error) console.warn('Supabase delete error', error);
        }
        backendStatus.textContent = 'Guardado en Supabase ‚úÖ';
      }
    }

    // ======= INIT =======
    (async function init(){
      if (supabase) backendStatus.textContent = 'Conectado a Supabase (guardado para todos)';
      loadLocal();
      if (supabase) await loadRemote(viewYear);
      draw();
    })();
  </script>
</body>
</html>
